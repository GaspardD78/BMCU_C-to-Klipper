# Board pin aliases for the Bambu BMCU-C mainboard
# Extracted from pbmcu_c_hall/BMCU-C Hall schematics.

[board_pins bmcu_c]
aliases:
    # Debug / RS-485 header H2
    swclk=PA14, swdio=PA13,
    rs485_tx=PA9, rs485_rx=PA10, rs485_de=PA12,
    exit_tx=PB10, exit_rx=PB11,

    # Status LED and passive light pipes
    status_led=PD1,
    rgb_out1=PB0, rgb_out2=PB1, rgb_out3=PA8, rgb_out4=PA11,

    # AT8236 driver inputs (one pair per spool motor)
    motor1_h=PA15, motor1_l=PB3,
    motor2_h=PB4,  motor2_l=PB5,
    motor3_h=PB6,  motor3_l=PB7,
    motor4_h=PB8,  motor4_l=PB9,
    spool1_step=AT8236_M1_STEP, spool1_dir=AT8236_M1_DIR,
    spool2_step=AT8236_M2_STEP, spool2_dir=AT8236_M2_DIR,
    spool3_step=AT8236_M3_STEP, spool3_dir=AT8236_M3_DIR,
    spool4_step=AT8236_M4_STEP, spool4_dir=AT8236_M4_DIR,

    # Sensor mezzanine connectors CN2..CN5
    spool1_sda=PC13, spool1_scl=PB12,
    spool1_pull=PA0, spool1_online=PA1,
    spool2_sda=PC14, spool2_scl=PB13,
    spool2_pull=PA2, spool2_online=PA3,
    spool3_sda=PC15, spool3_scl=PB14,
    spool3_pull=PA4, spool3_online=PA5,
    spool4_sda=PD0,  spool4_scl=PB15,
    spool4_pull=PA6, spool4_online=PA7,
    spool1_hall=PA1, spool2_hall=PA3, spool3_hall=PA5, spool4_hall=PA7,
    spool1_ir=PA0,   spool2_ir=PA2,   spool3_ir=PA4,   spool4_ir=PA6,
    ws2812=PD1

# Example control objects for the four spool motors and RGB indicator
[manual_stepper bmcu_c_spool_1]
step_pin: bmcu_c:spool1_step
dir_pin: bmcu_c:spool1_dir
rotation_distance: 22.0
velocity: 40
accel: 600
endstop_pin: ^bmcu_c:spool1_hall

[manual_stepper bmcu_c_spool_2]
step_pin: bmcu_c:spool2_step
dir_pin: bmcu_c:spool2_dir
rotation_distance: 22.0
velocity: 40
accel: 600
endstop_pin: ^bmcu_c:spool2_hall

[manual_stepper bmcu_c_spool_3]
step_pin: bmcu_c:spool3_step
dir_pin: bmcu_c:spool3_dir
rotation_distance: 22.0
velocity: 40
accel: 600
endstop_pin: ^bmcu_c:spool3_hall

[manual_stepper bmcu_c_spool_4]
step_pin: bmcu_c:spool4_step
dir_pin: bmcu_c:spool4_dir
rotation_distance: 22.0
velocity: 40
accel: 600
endstop_pin: ^bmcu_c:spool4_hall

[neopixel bmcu_c_status]
pin: bmcu_c:ws2812
chain_count: 1
color_order: GRB

[gcode_macro BMCU_ENABLE_SPOOLS]
description: Enable all BMCU-C spool motors
gcode:
    {% for name in ("bmcu_c_spool_1", "bmcu_c_spool_2", "bmcu_c_spool_3", "bmcu_c_spool_4") -%}
MANUAL_STEPPER STEPPER={{name}} ENABLE=1
    {% endfor %}

[gcode_macro BMCU_DISABLE_SPOOLS]
description: Disable all BMCU-C spool motors
gcode:
    {% for name in ("bmcu_c_spool_1", "bmcu_c_spool_2", "bmcu_c_spool_3", "bmcu_c_spool_4") -%}
MANUAL_STEPPER STEPPER={{name}} ENABLE=0
    {% endfor %}

[gcode_macro BMCU_HOME]
description: Zero the virtual axes used for the BMCU-C spool motors
gcode:
    {% for name in ("bmcu_c_spool_1", "bmcu_c_spool_2", "bmcu_c_spool_3", "bmcu_c_spool_4") -%}
MANUAL_STEPPER STEPPER={{name}} SET_POSITION=0
    {% endfor %}

[gcode_macro BMCU_SPOOL_MOVE]
description: Move a BMCU-C spool motor by a given distance
gcode:
    {% set gate = params.GATE|int %}
    {% set move = params.MOVE|float %}
    {% set velocity = params.VELOCITY|default(30.0)|float %}
    {% set accel = params.ACCEL|default(400.0)|float %}
    {% set steppers = ["bmcu_c_spool_1", "bmcu_c_spool_2", "bmcu_c_spool_3", "bmcu_c_spool_4"] %}
    {% if gate < 1 or gate > steppers|length %}
        {action_raise_error("Invalid GATE parameter")}
    {% endif %}
MANUAL_STEPPER STEPPER={{steppers[gate-1]}} VELOCITY={{velocity}} ACCEL={{accel}} MOVE={{move}}
